<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贪吃蛇游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2E7D32',
                        accent: '#FF9800',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        game: ['"Press Start 2P"', 'system-ui', 'sans-serif'],
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .pixel-borders {
                @apply border-4 border-dark border-t-primary/30 border-l-primary/30;
            }
            .game-button {
                @apply px-4 py-2 rounded-lg font-bold transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .snake-head {
                @apply bg-secondary rounded-sm;
            }
            .snake-body {
                @apply bg-primary rounded-sm;
            }
            .food {
                @apply bg-accent rounded-full;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@solana/web3.js@1.88.2/lib/index.iife.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-dark to-slate-800 min-h-screen flex flex-col items-center justify-center p-4 font-sans text-light">
    <!-- 左上角代币CA信息 -->
    <div id="caInfo" class="fixed top-6 left-6 z-50 bg-slate-800/90 px-4 py-2 rounded-lg shadow text-accent font-bold text-sm flex items-center"></div>
    <!-- 侧边栏：游戏说明 -->
    <aside class="fixed top-1/2 left-8 -translate-y-1/2 w-64 bg-slate-800/80 rounded-xl shadow-lg p-6 hidden lg:block z-40">
      <h2 id="gameDescTitle" class="text-lg font-bold text-light mb-2 flex items-center">
        <i class="fa fa-book text-primary mr-2"></i>
      </h2>
      <ul id="gameDescList" class="list-disc list-inside text-sm space-y-1 text-slate-300"></ul>
    </aside>
    <!-- 任务弹窗 -->
    <div id="taskModal" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center hidden">
      <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-2xl relative">
        <button id="closeTaskBtn" class="absolute top-4 right-4 text-slate-400 hover:text-primary text-2xl"><i class="fa fa-times"></i></button>
        <h2 id="taskCenterTitle" class="text-2xl font-bold text-primary mb-6 text-center font-game"><i class="fa fa-tasks mr-2"></i></h2>
        <div class="flex flex-col gap-4">
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <span id="myInviteCodeLabel" class="font-bold text-primary"></span>
            <span id="myInviteCode" class="bg-slate-700 px-2 py-1 rounded text-accent select-all cursor-pointer"></span>
            <button id="copyInviteCodeBtn" class="ml-2 game-button bg-primary text-white px-2 py-1 text-sm"></button>
          </div>
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <input id="inputInviteCode" type="text" class="px-2 py-1 rounded border border-slate-600 bg-slate-700 text-light focus:outline-none focus:ring-2 focus:ring-primary/50" />
            <button id="submitInviteCodeBtn" class="game-button bg-accent text-white px-2 py-1 text-sm"></button>
          </div>
          <div class="flex flex-col md:flex-row md:items-center gap-2">
            <span id="inviteCountLabel" class="text-slate-300"></span> <span id="inviteCount">0</span> <span id="peopleLabel" class="text-slate-300"></span>
            <span id="inviteBonusLabel" class="text-slate-300"></span><span id="inviteBonus">1.0</span><span id="timesLabel" class="text-slate-300"></span>
          </div>
          <div id="inviteRule" class="text-xs text-slate-400 mt-2 md:mt-0 w-full md:w-auto"></div>
        </div>
      </div>
    </div>
    <!-- 右上角连接钱包按钮 -->
    <div id="walletConnectContainer" class="fixed top-6 right-6 z-50 flex items-center">
      <button id="connectWalletBtn" class="game-button bg-primary text-white hover:bg-secondary focus:ring-primary/50">
        <i class="fa fa-link mr-2"></i>
        <span id="walletBtnText">连接钱包</span>
      </button>
      <span id="walletScore" class="ml-2 text-accent font-bold">积分: 0</span>
      <button id="claimTokenBtnTop" class="game-button bg-accent text-white ml-2">领取代币</button>
      <button id="testScoreBtn" class="game-button bg-accent text-white ml-2">测试加分</button>
      <button id="shopBtn" class="game-button bg-slate-500 text-white ml-2"></button>
      <button id="taskBtn" class="game-button bg-slate-500 text-white ml-2 flex items-center"></button>
      <button id="switchLangBtn" class="game-button bg-primary text-white ml-2"></button>
    </div>
    <!-- 商店模态弹窗 -->
    <div id="shopModal" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center hidden">
      <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-md relative">
        <button id="closeShopBtn" class="absolute top-4 right-4 text-slate-400 hover:text-primary text-2xl"><i class="fa fa-times"></i></button>
        <h2 class="text-2xl font-bold text-primary mb-6 text-center font-game"><i class="fa fa-shopping-cart mr-2"></i><span id="shopTitle">游戏商店</span></h2>
        <div class="bg-slate-800 rounded-lg p-4 flex flex-col items-center mb-4">
          <div class="flex items-center mb-2">
            <i class="fa fa-bolt text-accent text-3xl mr-3"></i>
            <span id="doubleCardLabel" class="text-xl font-bold text-light"></span>
          </div>
          <p id="doubleCardDesc" class="text-slate-300 text-center mb-2"></p>
          <div class="flex items-center gap-4 mt-2">
            <span id="doubleCardPrice" class="text-accent font-bold text-lg">1000</span>
            <button id="buyDoubleCardBtn" class="game-button bg-accent text-white"></button>
          </div>
          <div class="mt-2 text-slate-400 text-sm"><span id="doubleCardCountLabel"></span><span id="doubleCardCount">0</span></div>
        </div>
      </div>
    </div>
    <div class="max-w-3xl w-full bg-slate-900/80 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden">
        <!-- 游戏标题 -->
        <header class="bg-primary/10 px-6 py-4 border-b border-primary/30">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-game text-primary tracking-wider text-center">贪吃蛇大作战</h1>
        </header>

        <!-- 游戏主界面 -->
        <main class="p-6 flex flex-col lg:flex-row gap-6">
            <!-- 游戏信息 -->
            <div class="w-full lg:w-1/3 bg-slate-800/50 rounded-xl p-4 flex flex-col gap-4">
                <div class="bg-slate-700/50 rounded-lg p-4">
                    <h2 id="scoreTitle" class="text-lg font-bold text-light mb-2 flex items-center">
                        <i class="fa fa-trophy text-accent mr-2"></i>
                    </h2>
                    <p class="text-4xl font-game text-center text-primary" id="score">0</p>
                </div>

                <div class="bg-slate-700/50 rounded-lg p-4">
                    <h2 id="highScoreTitle" class="text-lg font-bold text-light mb-2 flex items-center">
                        <i class="fa fa-star text-accent mr-2"></i>
                    </h2>
                    <p class="text-4xl font-game text-center text-accent" id="highScore">0</p>
                </div>

                <div class="bg-slate-700/50 rounded-lg p-4">
                    <h2 id="gameStatusTitle" class="text-lg font-bold text-light mb-2 flex items-center">
                        <i class="fa fa-info-circle text-primary mr-2"></i>
                    </h2>
                    <p class="text-xl font-game text-center text-light" id="gameStatus">准备开始</p>
                </div>

                <!-- 游戏控制按钮 -->
                <div class="flex flex-col gap-3 mt-auto">
                    <button id="startBtn" class="game-button bg-primary text-white hover:bg-secondary focus:ring-primary/50"></button>
                    <button id="restartBtn" class="game-button bg-accent text-white hover:bg-orange-600 focus:ring-accent/50" disabled></button>
                    <button id="closeBtn" class="game-button bg-slate-600 text-white hover:bg-slate-700 focus:ring-slate-500/50"></button>
                </div>

            </div>

            <!-- 游戏画布 -->
            <div class="w-full lg:w-2/3 flex flex-col items-center">
                <div class="relative bg-slate-800/50 rounded-xl p-4">
                    <canvas id="gameCanvas" class="pixel-borders bg-slate-900 rounded-lg"></canvas>
                    
                    <!-- 游戏结束遮罩 -->
                    <div id="gameOver" class="hidden absolute inset-0 bg-dark/80 flex flex-col items-center justify-center rounded-lg">
                        <h2 class="text-3xl font-game text-accent mb-4">游戏结束!</h2>
                        <p class="text-xl font-game text-light mb-2">你的得分: <span id="finalScore" class="text-primary">0</span></p>
                        <p class="text-lg font-game text-light mb-6">最高分: <span id="finalHighScore" class="text-accent">0</span></p>
                        <button id="playAgainBtn" class="game-button bg-accent text-white hover:bg-orange-600 focus:ring-accent/50">
                            <i class="fa fa-refresh mr-2"></i>再玩一次
                        </button>
                        <button id="claimTokenBtn" class="game-button bg-primary text-white mt-4">
                            领取代币
                        </button>
                    </div>
                </div>

                <!-- 移动端控制按钮 -->
                <div class="lg:hidden grid grid-cols-3 gap-2 mt-6 w-full max-w-xs">
                    <div></div>
                    <button id="upBtn" class="game-button bg-slate-700 text-white">
                        <i class="fa fa-arrow-up"></i>
                    </button>
                    <div></div>
                    <button id="leftBtn" class="game-button bg-slate-700 text-white">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <div></div>
                    <button id="rightBtn" class="game-button bg-slate-700 text-white">
                        <i class="fa fa-arrow-right"></i>
                    </button>
                    <div></div>
                    <button id="downBtn" class="game-button bg-slate-700 text-white">
                        <i class="fa fa-arrow-down"></i>
                    </button>
                    <div></div>
                </div>
            </div>
        </main>

        <!-- 游戏底部信息 -->
        <footer class="bg-slate-800/50 px-6 py-3 border-t border-slate-700 text-sm text-slate-400 flex justify-between items-center">
            <p id="footerTitle"></p>
            <div class="flex space-x-4">
                <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-github"></i></a>
                <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-twitter"></i></a>
                <a href="#" class="hover:text-primary transition-colors"><i class="fa fa-envelope"></i></a>
            </div>
        </footer>
    </div>

    <script>
    // ====== 多语言文本和状态映射，必须最前面定义 ======
    const i18n = {
      score: { zh: "得分", en: "Score" },
      highScore: { zh: "最高分", en: "High Score" },
      gameStatus: { zh: "游戏状态", en: "Game Status" },
      startGame: { zh: "开始游戏", en: "Start Game" },
      restart: { zh: "重新开始", en: "Restart" },
      close: { zh: "关闭游戏", en: "Close" },
      playAgain: { zh: "再玩一次", en: "Play Again" },
      claimToken: { zh: "领取代币", en: "Claim Token" },
      shop: { zh: "商店", en: "Shop" },
      task: { zh: "任务", en: "Task" },
      connectWallet: { zh: "连接钱包", en: "Connect Wallet" },
      disconnectWallet: { zh: "断开钱包", en: "Disconnect Wallet" },
      walletScore: { zh: "积分", en: "Points" },
      testScore: { zh: "测试加分", en: "Test Score" },
      doubleCard: { zh: "双倍卡", en: "Double Card" },
      doubleCardDesc: { zh: "购买后本账号获得的游戏积分永久翻倍，可叠加，每次购买价格上涨150%。", en: "Doubles your game points permanently, can be stacked, price increases by 150% each time." },
      buy: { zh: "购买", en: "Buy" },
      owned: { zh: "已拥有", en: "Owned" },
      gameDescTitle: { zh: "游戏说明", en: "Game Instructions" },
      gameDesc: {
        zh: [
          "使用方向键或WASD控制蛇的移动",
          "吃到食物得10分",
          "本局内每获得100分，后续吃到的食物积分翻倍（仅本局有效，可多次翻倍）",
          "撞到墙壁或自己的身体游戏结束",
          "游戏速度会随着得分增加而提高",
          "每获得1积分可兑换10个代币",
          "加分规则：",
          "购买“双倍卡”可让本账号获得的积分翻倍，支持多次叠加（如2张=4倍，3张=8倍）",
          "每邀请1位有效好友（填写你的邀请码且钱包≥1 SOL），你的积分加成+50%，可叠加",
          "填写邀请码也可获得20%积分加成（仅加一次）",
          "所有加成可叠加，最终得分=基础分×双倍卡倍率×邀请加成倍率×被邀请加成"
        ],
        en: [
          "Use arrow keys or WASD to control the snake",
          "Earn 10 points for each food eaten",
          "For every 100 points in a game, food points double (only for this game, can stack multiple times)",
          "Game ends if you hit the wall or yourself",
          "Game speed increases as your score increases",
          "Each point can be exchanged for 10 tokens",
          "Scoring rules:",
          "Buying 'Double Card' doubles your points, can be stacked (2 cards=4x, 3 cards=8x)",
          "For each valid invite (invite code filled and wallet ≥1 SOL), your points bonus +50%, can stack",
          "Filling an invite code also gives you a 20% bonus (only once)",
          "All bonuses stack, final score = base × double card × invite bonus × invited bonus"
        ]
      },
      myInviteCode: { zh: "我的邀请码：", en: "My Invite Code:" },
      copy: { zh: "复制", en: "Copy" },
      copied: { zh: "已复制", en: "Copied" },
      fillInvite: { zh: "填写好友邀请码", en: "Enter Friend's Invite Code" },
      submit: { zh: "提交", en: "Submit" },
      invited: { zh: "已邀请", en: "Invited" },
      people: { zh: "人", en: "People" },
      currentBonus: { zh: "当前加成：", en: "Current Bonus:" },
      times: { zh: "倍", en: "x" },
      inviteRule: { zh: "* 只有填写邀请码的钱包余额≥1 SOL，才算有效邀请，每邀请1人积分加成+50%，可叠加", en: "* Only wallets with ≥1 SOL are valid invites. Each valid invite gives +50% bonus, can stack." },
      taskCenter: { zh: "任务中心", en: "Task Center" },
      switchLang: { zh: "切换为英文", en: "Switch to Chinese" },
      ca: { zh: "CA：soon", en: "CA: soon" },
      ownedCount: { zh: "已拥有：", en: "Owned:" },
      price: { zh: "价格：", en: "Price:" },
      pageTitle: { zh: "贪吃蛇大作战", en: "Snake Battle" },
      multiplierLabel: { zh: "当前总加成：", en: "Total Multiplier:" }
    };
    let currentLang = 'zh';
    const statusMap = {
      ready: { zh: '准备开始', en: 'Ready' },
      running: { zh: '游戏进行中', en: 'Running' },
      over: { zh: '游戏结束', en: 'Game Over' },
      paused: { zh: '游戏暂停', en: 'Paused' },
      closed: { zh: '游戏已关闭', en: 'Closed' }
    };
    function renderTexts() {
      // 页标题
      document.title = i18n.pageTitle[currentLang];
      // 页脚
      const footerTitle = document.getElementById('footerTitle');
      if (footerTitle) footerTitle.textContent = `© 2025 ${i18n.pageTitle[currentLang]}`;
      // 游戏状态内容
      if (window.gameStatusElement && window.currentGameStatusKey) {
        window.gameStatusElement.textContent = statusMap[window.currentGameStatusKey][currentLang];
      }
      // 倍率显示
      const multiplierElement = document.getElementById('multiplierDisplay');
      if (multiplierElement && typeof window.totalMultiplier !== 'undefined') {
        multiplierElement.textContent = `${i18n.multiplierLabel[currentLang]}${window.totalMultiplier.toFixed(2)}${currentLang === 'zh' ? '倍' : 'x'}`;
      }
      // 顶部CA
      const caDiv = document.getElementById('caInfo');
      if (caDiv) caDiv.innerHTML = `<i class='fa fa-cube mr-2'></i>${i18n.ca[currentLang]}`;
      // 游戏说明
      const descTitle = document.getElementById('gameDescTitle');
      if (descTitle) descTitle.textContent = i18n.gameDescTitle[currentLang];
      const descList = document.getElementById('gameDescList');
      if (descList) {
        descList.innerHTML = '';
        i18n.gameDesc[currentLang].forEach(line => {
          const li = document.createElement('li');
          li.textContent = line;
          descList.appendChild(li);
        });
      }
      // 得分区
      const scoreTitle = document.getElementById('scoreTitle');
      if (scoreTitle) scoreTitle.textContent = i18n.score[currentLang];
      const highScoreTitle = document.getElementById('highScoreTitle');
      if (highScoreTitle) highScoreTitle.textContent = i18n.highScore[currentLang];
      const gameStatusTitle = document.getElementById('gameStatusTitle');
      if (gameStatusTitle) gameStatusTitle.textContent = i18n.gameStatus[currentLang];
      // 按钮
      const startBtn = document.getElementById('startBtn');
      if (startBtn) startBtn.innerHTML = `<i class='fa fa-play mr-2'></i>${i18n.startGame[currentLang]}`;
      const restartBtn = document.getElementById('restartBtn');
      if (restartBtn) restartBtn.innerHTML = `<i class='fa fa-refresh mr-2'></i>${i18n.restart[currentLang]}`;
      const closeBtn = document.getElementById('closeBtn');
      if (closeBtn) closeBtn.innerHTML = `<i class='fa fa-times mr-2'></i>${i18n.close[currentLang]}`;
      const playAgainBtn = document.getElementById('playAgainBtn');
      if (playAgainBtn) playAgainBtn.innerHTML = `<i class='fa fa-refresh mr-2'></i>${i18n.playAgain[currentLang]}`;
      const claimTokenBtn = document.getElementById('claimTokenBtn');
      if (claimTokenBtn) claimTokenBtn.textContent = i18n.claimToken[currentLang];
      const claimTokenBtnTop = document.getElementById('claimTokenBtnTop');
      if (claimTokenBtnTop) claimTokenBtnTop.textContent = i18n.claimToken[currentLang];
      const shopBtn = document.getElementById('shopBtn');
      if (shopBtn) shopBtn.innerHTML = `<i class='fa fa-shopping-cart mr-1'></i>${i18n.shop[currentLang]}`;
      const taskBtn = document.getElementById('taskBtn');
      if (taskBtn) taskBtn.innerHTML = `<i class='fa fa-tasks mr-1'></i>${i18n.task[currentLang]}`;
      const connectWalletBtn = document.getElementById('connectWalletBtn');
      if (connectWalletBtn) connectWalletBtn.innerHTML = `<i class='fa fa-link mr-2'></i>${i18n.connectWallet[currentLang]}`;
      const testScoreBtn = document.getElementById('testScoreBtn');
      if (testScoreBtn) testScoreBtn.textContent = i18n.testScore[currentLang];
      // 商店
      const buyDoubleCardBtn = document.getElementById('buyDoubleCardBtn');
      if (buyDoubleCardBtn) buyDoubleCardBtn.textContent = i18n.buy[currentLang];
      const doubleCardCountLabel = document.getElementById('doubleCardCountLabel');
      if (doubleCardCountLabel) doubleCardCountLabel.textContent = i18n.ownedCount[currentLang];
      const doubleCardLabel = document.getElementById('doubleCardLabel');
      if (doubleCardLabel) doubleCardLabel.textContent = i18n.doubleCard[currentLang];
      const doubleCardDesc = document.getElementById('doubleCardDesc');
      if (doubleCardDesc) doubleCardDesc.textContent = i18n.doubleCardDesc[currentLang];
      // 任务弹窗
      const myInviteCodeLabel = document.getElementById('myInviteCodeLabel');
      if (myInviteCodeLabel) myInviteCodeLabel.textContent = i18n.myInviteCode[currentLang];
      const copyInviteCodeBtn = document.getElementById('copyInviteCodeBtn');
      if (copyInviteCodeBtn) copyInviteCodeBtn.textContent = i18n.copy[currentLang];
      const inputInviteCode = document.getElementById('inputInviteCode');
      if (inputInviteCode) inputInviteCode.placeholder = i18n.fillInvite[currentLang];
      const submitInviteCodeBtn = document.getElementById('submitInviteCodeBtn');
      if (submitInviteCodeBtn) submitInviteCodeBtn.textContent = i18n.submit[currentLang];
      const inviteCountLabel = document.getElementById('inviteCountLabel');
      if (inviteCountLabel) inviteCountLabel.textContent = i18n.invited[currentLang];
      const inviteBonusLabel = document.getElementById('inviteBonusLabel');
      if (inviteBonusLabel) inviteBonusLabel.textContent = i18n.currentBonus[currentLang];
      const inviteRule = document.getElementById('inviteRule');
      if (inviteRule) inviteRule.textContent = i18n.inviteRule[currentLang];
      const taskCenterTitle = document.getElementById('taskCenterTitle');
      if (taskCenterTitle) taskCenterTitle.textContent = i18n.taskCenter[currentLang];
      const switchLangBtn = document.getElementById('switchLangBtn');
      if (switchLangBtn) switchLangBtn.textContent = i18n.switchLang[currentLang];
    }
    </script>
    <script>
        // 游戏常量
        const GRID_SIZE = 20;
        const INITIAL_SPEED = 150;
        const MIN_SPEED = 60;
        const SPEED_INCREMENT = 5;
        const BASE_POINTS_PER_FOOD = 10;

        // 新增：每100分食物积分翻倍（本局内）
        function getCurrentFoodPoints(score) {
            // 100分一档，10分起步
            const times = Math.floor(score / 100);
            return BASE_POINTS_PER_FOOD * Math.pow(2, times);
        }

        // 获取DOM元素
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        // 新增：显示总加成倍数
        let totalMultiplier = 1.0;
        const multiplierElement = document.createElement('div');
        multiplierElement.className = 'text-xs text-accent text-center mt-1';
        multiplierElement.id = 'multiplierDisplay';
        scoreElement.parentElement.appendChild(multiplierElement);
        const highScoreElement = document.getElementById('highScore');
        const gameStatusElement = document.getElementById('gameStatus');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const closeBtn = document.getElementById('closeBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const gameOverElement = document.getElementById('gameOver');
        const finalScoreElement = document.getElementById('finalScore');
        const finalHighScoreElement = document.getElementById('finalHighScore');
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // 游戏变量
        let snake = [];
        let food = {};
        let direction = '';
        let nextDirection = '';
        let gameSpeed = INITIAL_SPEED;
        let score = 0;         // 显示和上传用
        let baseScore = 0;     // 只加基础分
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        // 新增：本地缓存加成
        window.doubleCardCount = 0;
        window.inviteBonus = 1.0;
        window.invitedBonus = 1.0;
        let gameInterval;
        let isGameRunning = false;
        let canvasSize = 0;
        let cellSize = 0;

        // 初始化高分显示
        highScoreElement.textContent = highScore;

        // Firebase 初始化
        const firebaseConfig = {
            apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
            authDomain: "chat-294cc.firebaseapp.com",
            databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
            projectId: "chat-294cc",
            storageBucket: "chat-294cc.appspot.com",
            messagingSenderId: "913615304269",
            appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
            measurementId: "G-SJR9NDW86B"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // 积分显示相关
        const walletScore = document.getElementById('walletScore');
        async function updateWalletScore() {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                walletScore.textContent = '积分: 0';
                return;
            }
            try {
                const snap = await firebase.database().ref('users/' + addr + '/score').get();
                const score = snap.exists() ? snap.val() : 0;
                walletScore.textContent = '积分: ' + score;
            } catch (e) {
                walletScore.textContent = '积分: 0';
            }
        }
        // 初始刷新
        updateWalletScore();

        // 钱包连接相关
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletBtnText = document.getElementById('walletBtnText');
        let isWalletConnected = false;

        function updateWalletBtnUI(addr) {
            if (addr) {
                walletBtnText.textContent = addr.slice(0, 4) + "..." + addr.slice(-4) + " (点击断开)";
                isWalletConnected = true;
            } else {
                walletBtnText.textContent = "连接钱包";
                isWalletConnected = false;
            }
        }

        function restoreWalletAddress() {
            const saved = localStorage.getItem('userWalletAddress');
            updateWalletBtnUI(saved);
            updateWalletScore();
        }
        restoreWalletAddress();

        async function connectWallet() {
            const saved = localStorage.getItem('userWalletAddress');
            if (isWalletConnected && saved) {
                // 断开连接
                localStorage.removeItem('userWalletAddress');
                updateWalletBtnUI(null);
                updateWalletScore();
                return;
            }
            if (!window.solana || !window.solana.isPhantom) {
                alert("请先安装 Phantom 钱包");
                return;
            }
            try {
                const resp = await window.solana.connect();
                const addr = resp.publicKey.toString();
                localStorage.setItem('userWalletAddress', addr);
                updateWalletBtnUI(addr);
                updateWalletScore();
            } catch (e) {
                alert("钱包连接失败: " + (e.message || e));
            }
        }

        if (connectWalletBtn) {
            connectWalletBtn.addEventListener('click', () => {
                console.log("点击了连接钱包按钮");
                connectWallet();
            });
        }

        // 商店弹窗逻辑
        const shopBtn = document.getElementById('shopBtn');
        const shopModal = document.getElementById('shopModal');
        const closeShopBtn = document.getElementById('closeShopBtn');
        shopBtn.addEventListener('click', () => {
            shopModal.classList.remove('hidden');
        });
        closeShopBtn.addEventListener('click', () => {
            shopModal.classList.add('hidden');
        });
        // 点击弹窗外部关闭
        shopModal.addEventListener('click', (e) => {
            if (e.target === shopModal) {
                shopModal.classList.add('hidden');
            }
        });

        // 商店相关变量
        const buyDoubleCardBtn = document.getElementById('buyDoubleCardBtn');
        const doubleCardPriceSpan = document.getElementById('doubleCardPrice');
        const doubleCardCountSpan = document.getElementById('doubleCardCount');
        let doubleCardCount = 0;
        let doubleCardPrice = 1000;

        // 读取双倍卡数据
        async function loadDoubleCardData() {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                doubleCardCount = 0;
                doubleCardPrice = 1000;
                doubleCardCountSpan.textContent = '0';
                doubleCardPriceSpan.textContent = '1000';
                return;
            }
            try {
                const snap = await firebase.database().ref('users/' + addr).get();
                const data = snap.exists() ? snap.val() : {};
                doubleCardCount = data.doubleCardCount || 0;
                doubleCardPrice = data.doubleCardPrice || 1000;
                doubleCardCountSpan.textContent = doubleCardCount;
                doubleCardPriceSpan.textContent = doubleCardPrice;
            } catch (e) {
                doubleCardCount = 0;
                doubleCardPrice = 1000;
                doubleCardCountSpan.textContent = '0';
                doubleCardPriceSpan.textContent = '1000';
            }
        }

        // 打开商店时刷新
        shopBtn.addEventListener('click', () => {
            shopModal.classList.remove('hidden');
            loadDoubleCardData();
        });

        // 购买双倍卡
        buyDoubleCardBtn.addEventListener('click', async () => {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                alert('请先连接钱包');
                return;
            }
            // 先获取最新积分和双倍卡数据
            const userRef = firebase.database().ref('users/' + addr);
            const snap = await userRef.get();
            const data = snap.exists() ? snap.val() : {};
            let score = data.score || 0;
            let count = data.doubleCardCount || 0;
            let price = data.doubleCardPrice || 1000;
            if (score < price) {
                alert('积分不足，无法购买');
                return;
            }
            // 计算新价格
            const newCount = count + 1;
            const newPrice = Math.ceil(price * 2.5);
            // 扣除积分并更新
            await userRef.update({
                score: score - price,
                doubleCardCount: newCount,
                doubleCardPrice: newPrice
            });
            alert('购买成功！');
            loadDoubleCardData();
            updateWalletScore();
        });

        // 任务栏相关变量
        const myInviteCodeSpan = document.getElementById('myInviteCode');
        const copyInviteCodeBtn = document.getElementById('copyInviteCodeBtn');
        const inputInviteCode = document.getElementById('inputInviteCode');
        const submitInviteCodeBtn = document.getElementById('submitInviteCodeBtn');
        const inviteCountSpan = document.getElementById('inviteCount');
        const inviteBonusSpan = document.getElementById('inviteBonus');

        // 显示邀请码（用钱包地址后8位）
        function getMyInviteCode() {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) return '';
            return addr.slice(-8);
        }

        // 复制邀请码
        copyInviteCodeBtn.addEventListener('click', () => {
            const code = myInviteCodeSpan.textContent;
            navigator.clipboard.writeText(code);
            copyInviteCodeBtn.textContent = '已复制';
            setTimeout(() => { copyInviteCodeBtn.innerHTML = '<i class="fa fa-copy"></i> 复制'; }, 1200);
        });

        // 加载任务栏数据
        async function loadInviteTaskBar() {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                myInviteCodeSpan.textContent = '';
                inviteCountSpan.textContent = '0';
                inviteBonusSpan.textContent = '1.0';
                inputInviteCode.disabled = true;
                submitInviteCodeBtn.disabled = true;
                return;
            }
            myInviteCodeSpan.textContent = getMyInviteCode();
            inputInviteCode.disabled = false;
            submitInviteCodeBtn.disabled = false;
            try {
                const snap = await firebase.database().ref('users/' + addr).get();
                const data = snap.exists() ? snap.val() : {};
                inviteCountSpan.textContent = data.inviteCount || 0;
                inviteBonusSpan.textContent = data.inviteBonus ? data.inviteBonus.toFixed(2) : '1.0';
                if (data.invitedBy) {
                    inputInviteCode.value = data.invitedBy;
                    inputInviteCode.disabled = true;
                    submitInviteCodeBtn.disabled = true;
                }
            } catch (e) {
                inviteCountSpan.textContent = '0';
                inviteBonusSpan.textContent = '1.0';
            }
        }

        // 检查钱包余额是否≥1 SOL
        async function checkWalletBalance1SOL(addr) {
            try {
                if (!window.solana) return false;
                const connection = new solanaWeb3.Connection('https://api.mainnet-beta.solana.com');
                const pubkey = new solanaWeb3.PublicKey(addr);
                const balance = await connection.getBalance(pubkey);
                return balance >= 1e9; // 1 SOL = 1e9 lamports
            } catch (e) {
                return false;
            }
        }

        // 提交邀请码
        submitInviteCodeBtn.addEventListener('click', async () => {
            const addr = localStorage.getItem('userWalletAddress');
            const code = inputInviteCode.value.trim();
            if (!addr || !code) {
                alert('请先连接钱包并填写邀请码');
                return;
            }
            if (code === getMyInviteCode()) {
                alert('不能填写自己的邀请码');
                return;
            }
            // 检查是否已填写过
            const userRef = firebase.database().ref('users/' + addr);
            const snap = await userRef.get();
            const data = snap.exists() ? snap.val() : {};
            if (data.invitedBy) {
                alert('你已经填写过邀请码');
                return;
            }
            // 检查钱包余额
            submitInviteCodeBtn.disabled = true;
            submitInviteCodeBtn.textContent = '检测中...';
            const has1SOL = await checkWalletBalance1SOL(addr);
            if (!has1SOL) {
                alert('你的钱包余额不足1 SOL，无法作为有效邀请');
                submitInviteCodeBtn.disabled = false;
                submitInviteCodeBtn.textContent = '提交';
                return;
            }
            // 查找邀请人钱包地址
            let inviterAddr = null;
            const usersSnap = await firebase.database().ref('users').get();
            usersSnap.forEach(child => {
                const childAddr = child.key;
                if (childAddr && childAddr.slice(-8) === code) {
                    inviterAddr = childAddr;
                }
            });
            if (!inviterAddr) {
                alert('邀请码无效');
                submitInviteCodeBtn.disabled = false;
                submitInviteCodeBtn.textContent = '提交';
                return;
            }
            // 更新自己
            await userRef.update({ invitedBy: code, invitedBonus: 1.2 });
            // 更新邀请人
            const inviterRef = firebase.database().ref('users/' + inviterAddr);
            const inviterSnap = await inviterRef.get();
            const inviterData = inviterSnap.exists() ? inviterSnap.val() : {};
            const newInviteCount = (inviterData.inviteCount || 0) + 1;
            const newInviteBonus = (inviterData.inviteBonus || 1.0) + 0.5;
            const invitees = inviterData.invitees || [];
            if (!invitees.includes(addr)) invitees.push(addr);
            await inviterRef.update({
                inviteCount: newInviteCount,
                inviteBonus: newInviteBonus,
                invitees: invitees
            });
            alert('填写成功！你已成为有效邀请用户');
            loadInviteTaskBar();
        });

        // 任务弹窗逻辑
        const taskBtn = document.getElementById('taskBtn');
        const taskModal = document.getElementById('taskModal');
        const closeTaskBtn = document.getElementById('closeTaskBtn');
        taskBtn.addEventListener('click', () => {
            taskModal.classList.remove('hidden');
            loadInviteTaskBar();
        });
        closeTaskBtn.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });
        taskModal.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                taskModal.classList.add('hidden');
            }
        });

        // 页面加载时刷新任务栏和加成
        loadInviteTaskBar();
        fetchAllMultipliers();

        // 拉取加成数据（游戏开始时和钱包连接后）
        async function fetchAllMultipliers() {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                window.doubleCardCount = 0;
                window.inviteBonus = 1.0;
                window.invitedBonus = 1.0;
                totalMultiplier = 1.0;
                updateMultiplierDisplay();
                return;
            }
            try {
                const snap = await firebase.database().ref('users/' + addr).get();
                const data = snap.exists() ? snap.val() : {};
                window.doubleCardCount = data.doubleCardCount || 0;
                window.inviteBonus = data.inviteBonus || 1.0;
                window.invitedBonus = data.invitedBonus || 1.0;
                totalMultiplier = Math.pow(2, window.doubleCardCount) * window.inviteBonus * window.invitedBonus;
                updateMultiplierDisplay();
            } catch (e) {
                window.doubleCardCount = 0;
                window.inviteBonus = 1.0;
                window.invitedBonus = 1.0;
                totalMultiplier = 1.0;
                updateMultiplierDisplay();
            }
        }

        function updateMultiplierDisplay() {
            const multiplierElement = document.getElementById('multiplierDisplay');
            if (multiplierElement) {
                multiplierElement.textContent = `${i18n.multiplierLabel[currentLang]}${totalMultiplier.toFixed(2)}${currentLang === 'zh' ? '倍' : 'x'}`;
            }
        }

        // 设置画布尺寸
        function setupCanvas() {
            // 响应式画布尺寸
            const containerWidth = canvas.parentElement.clientWidth;
            canvasSize = Math.min(containerWidth, 600);
            canvasSize = Math.floor(canvasSize / GRID_SIZE) * GRID_SIZE; // 确保网格对齐
            
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            
            cellSize = canvasSize / GRID_SIZE;
        }

        // 初始化游戏
        function initGame() {
            window.currentGameStatusKey = 'running';
            setupCanvas();
            // 拉取加成数据
            fetchAllMultipliers();
            // 初始化蛇 - 从中间开始
            const centerPos = Math.floor(GRID_SIZE / 2);
            snake = [
                {x: centerPos, y: centerPos},
                {x: centerPos - 1, y: centerPos},
                {x: centerPos - 2, y: centerPos}
            ];
            // 初始化方向
            direction = 'right';
            nextDirection = 'right';
            // 生成食物
            generateFood();
            // 重置分数和速度
            score = 0;
            baseScore = 0;
            gameSpeed = INITIAL_SPEED;
            // 更新UI
            updateScore();
            gameStatusElement.textContent = statusMap['running'][currentLang];
            // 隐藏游戏结束画面
            gameOverElement.classList.add('hidden');
            // 启用/禁用按钮
            startBtn.disabled = true;
            restartBtn.disabled = false;
            closeBtn.disabled = false;
            // 开始游戏循环
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, gameSpeed);
            isGameRunning = true;
        }

        // 生成食物
        function generateFood() {
            // 确保食物不会出现在蛇身上
            let overlapping;
            do {
                overlapping = false;
                food = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
                
                // 检查是否与蛇重叠
                for (let segment of snake) {
                    if (segment.x === food.x && segment.y === food.y) {
                        overlapping = true;
                        break;
                    }
                }
            } while (overlapping);
        }

        // 游戏主循环
        function gameLoop() {
            // 更新方向
            direction = nextDirection;
            // 检查是否撞到墙壁
            const head = {x: snake[0].x, y: snake[0].y};
            switch (direction) {
                case 'up':
                    head.y--;
                    break;
                case 'down':
                    head.y++;
                    break;
                case 'left':
                    head.x--;
                    break;
                case 'right':
                    head.x++;
                    break;
            }
            // 检查碰撞
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE) {
                gameOver();
                return;
            }
            // 检查是否撞到自己
            for (let i = 0; i < snake.length; i++) {
                if (snake[i].x === head.x && snake[i].y === head.y) {
                    gameOver();
                    return;
                }
            }
            // 将新头部添加到蛇
            snake.unshift(head);
            // 检查是否吃到食物
            if (head.x === food.x && head.y === food.y) {
                // 新规则：每100分食物积分翻倍
                const foodPoints = getCurrentFoodPoints(baseScore);
                baseScore += foodPoints;
                // 取本地缓存加成
                const doubleCardCount = window.doubleCardCount || 0;
                const inviteBonus = window.inviteBonus || 1.0;
                const invitedBonus = window.invitedBonus || 1.0;
                totalMultiplier = Math.pow(2, doubleCardCount) * inviteBonus * invitedBonus;
                updateMultiplierDisplay();
                const addScore = Math.floor(foodPoints * totalMultiplier);
                score += addScore;
                updateScore();
                // 生成新食物
                generateFood();
                // 提高游戏速度（有上限）
                if (gameSpeed > MIN_SPEED) {
                    gameSpeed -= SPEED_INCREMENT;
                    clearInterval(gameInterval);
                    gameInterval = setInterval(gameLoop, gameSpeed);
                }
            } else {
                // 如果没吃到食物，移除尾部
                snake.pop();
            }
            // 绘制游戏
            drawGame();
        }

        // 绘制游戏
        function drawGame() {
            // 清空画布
            ctx.fillStyle = '#1E293B';
            ctx.fillRect(0, 0, canvasSize, canvasSize);
            
            // 绘制网格（可选）
            ctx.strokeStyle = '#2D3748';
            ctx.lineWidth = 0.5;
            for (let i = 0; i < GRID_SIZE; i++) {
                const pos = i * cellSize;
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, canvasSize);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, pos);
                ctx.lineTo(canvasSize, pos);
                ctx.stroke();
            }
            
            // 绘制蛇
            snake.forEach((segment, index) => {
                if (index === 0) {
                    // 蛇头
                    ctx.fillStyle = '#2E7D32';
                    ctx.shadowColor = '#4CAF50';
                    ctx.shadowBlur = 10;
                } else {
                    // 蛇身
                    ctx.fillStyle = '#4CAF50';
                    ctx.shadowBlur = 0;
                }
                
                ctx.fillRect(segment.x * cellSize, segment.y * cellSize, cellSize, cellSize);
                
                // 蛇头的眼睛
                if (index === 0) {
                    ctx.fillStyle = '#FFFFFF';
                    const eyeSize = cellSize / 5;
                    const eyeOffset = cellSize / 3;
                    
                    // 根据方向设置眼睛位置
                    switch (direction) {
                        case 'up':
                            ctx.fillRect(segment.x * cellSize + cellSize / 4 - eyeSize / 2, segment.y * cellSize + eyeOffset, eyeSize, eyeSize);
                            ctx.fillRect(segment.x * cellSize + cellSize * 3/4 - eyeSize / 2, segment.y * cellSize + eyeOffset, eyeSize, eyeSize);
                            break;
                        case 'down':
                            ctx.fillRect(segment.x * cellSize + cellSize / 4 - eyeSize / 2, segment.y * cellSize + cellSize - eyeOffset - eyeSize, eyeSize, eyeSize);
                            ctx.fillRect(segment.x * cellSize + cellSize * 3/4 - eyeSize / 2, segment.y * cellSize + cellSize - eyeOffset - eyeSize, eyeSize, eyeSize);
                            break;
                        case 'left':
                            ctx.fillRect(segment.x * cellSize + eyeOffset, segment.y * cellSize + cellSize / 4 - eyeSize / 2, eyeSize, eyeSize);
                            ctx.fillRect(segment.x * cellSize + eyeOffset, segment.y * cellSize + cellSize * 3/4 - eyeSize / 2, eyeSize, eyeSize);
                            break;
                        case 'right':
                            ctx.fillRect(segment.x * cellSize + cellSize - eyeOffset - eyeSize, segment.y * cellSize + cellSize / 4 - eyeSize / 2, eyeSize, eyeSize);
                            ctx.fillRect(segment.x * cellSize + cellSize - eyeOffset - eyeSize, segment.y * cellSize + cellSize * 3/4 - eyeSize / 2, eyeSize, eyeSize);
                            break;
                    }
                }
            });
            
            // 绘制食物
            ctx.fillStyle = '#FF9800';
            ctx.shadowColor = '#FF9800';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(
                food.x * cellSize + cellSize / 2,
                food.y * cellSize + cellSize / 2,
                cellSize / 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        // 更新分数
        function updateScore() {
            scoreElement.textContent = score;
            
            // 更新最高分
            if (score > highScore) {
                highScore = score;
                highScoreElement.textContent = highScore;
                localStorage.setItem('snakeHighScore', highScore);
            }
        }

        async function uploadGameScore(gameScore) {
            const addr = localStorage.getItem('userWalletAddress');
            if (!addr) {
                console.log("用户未连接钱包，本次游戏分数不记录");
                return;
            }
            if (gameScore <= 0) {
                return;
            }
            try {
                const userRef = firebase.database().ref('users/' + addr);
                const snap = await userRef.get();
                const data = snap.exists() ? snap.val() : {};
                const doubleCardCount = data.doubleCardCount || 0;
                const inviteBonus = data.inviteBonus || 1.0;
                const invitedBonus = data.invitedBonus || 1.0;
                const currentTotalScore = data.score || 0;
                // 计算最终分数
                const multiplier = Math.pow(2, doubleCardCount) * inviteBonus * invitedBonus;
                const finalScore = Math.floor(gameScore * multiplier);
                const newTotalScore = parseInt(currentTotalScore) + finalScore;
                await userRef.update({ score: newTotalScore });
                console.log(`分数上传成功，新总分: ${newTotalScore}`);
                updateWalletScore();
            } catch (e) {
                console.error("分数上传失败: ", e);
                alert("分数上传失败: " + (e.message || e));
            }
        }

        // 游戏结束
        function gameOver() {
            window.currentGameStatusKey = 'over';
            clearInterval(gameInterval);
            isGameRunning = false;
            
            // 上传分数
            uploadGameScore(score);

            // 更新游戏结束画面
            finalScoreElement.textContent = score;
            finalHighScoreElement.textContent = highScore;
            gameOverElement.classList.remove('hidden');
            
            // 启用/禁用按钮
            startBtn.disabled = false;
            restartBtn.disabled = true;
        }

        // 关闭游戏
        function closeGame() {
            window.currentGameStatusKey = 'closed';
            clearInterval(gameInterval);
            isGameRunning = false;
            
            // 重置游戏状态
            snake = [];
            direction = '';
            nextDirection = '';
            
            // 更新UI
            gameStatusElement.textContent = statusMap['closed'][currentLang];
            scoreElement.textContent = '0';
            
            // 清空画布
            ctx.fillStyle = '#1E293B';
            ctx.fillRect(0, 0, canvasSize, canvasSize);
            
            // 隐藏游戏结束画面
            gameOverElement.classList.add('hidden');
            
            // 启用/禁用按钮
            startBtn.disabled = false;
            restartBtn.disabled = true;
            closeBtn.disabled = true;
        }

        // 键盘控制
        function handleKeyDown(e) {
            if (!isGameRunning) return;
            
            const key = e.key;
            
            // 防止180度转向（不能直接往相反方向走）
            switch (key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    if (direction !== 'down') {
                        nextDirection = 'up';
                    }
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    if (direction !== 'up') {
                        nextDirection = 'down';
                    }
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    if (direction !== 'right') {
                        nextDirection = 'left';
                    }
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    if (direction !== 'left') {
                        nextDirection = 'right';
                    }
                    break;
                case ' ': // 空格键暂停/继续
                    togglePause();
                    break;
            }
        }

        // 移动端控制
        function setupMobileControls() {
            upBtn.addEventListener('click', () => {
                if (direction !== 'down' && isGameRunning) {
                    nextDirection = 'up';
                }
            });
            
            downBtn.addEventListener('click', () => {
                if (direction !== 'up' && isGameRunning) {
                    nextDirection = 'down';
                }
            });
            
            leftBtn.addEventListener('click', () => {
                if (direction !== 'right' && isGameRunning) {
                    nextDirection = 'left';
                }
            });
            
            rightBtn.addEventListener('click', () => {
                if (direction !== 'left' && isGameRunning) {
                    nextDirection = 'right';
                }
            });
        }

        // 暂停/继续游戏
        function togglePause() {
            if (!isGameRunning) return;
            
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
                window.currentGameStatusKey = 'paused';
                gameStatusElement.textContent = statusMap['paused'][currentLang];
            } else {
                gameInterval = setInterval(gameLoop, gameSpeed);
                window.currentGameStatusKey = 'running';
                gameStatusElement.textContent = statusMap['running'][currentLang];
            }
        }

        // 响应式处理
        function handleResize() {
            const wasRunning = isGameRunning;
            if (wasRunning) {
                clearInterval(gameInterval);
            }
            
            setupCanvas();
            if (snake.length > 0) {
                drawGame();
            }
            
            if (wasRunning) {
                gameInterval = setInterval(gameLoop, gameSpeed);
            }
        }

        // 事件监听
        function setupEventListeners() {
            // 按钮事件
            startBtn.addEventListener('click', initGame);
            restartBtn.addEventListener('click', initGame);
            closeBtn.addEventListener('click', closeGame);
            playAgainBtn.addEventListener('click', initGame);
            
            // 键盘控制
            document.addEventListener('keydown', handleKeyDown);
            
            // 移动端控制
            setupMobileControls();
            
            // 窗口大小变化
            window.addEventListener('resize', handleResize);
        }

        // 初始化
        setupEventListeners();
        setupCanvas();

        // 累加加分逻辑
        const testScoreBtn = document.getElementById('testScoreBtn');
        if (testScoreBtn) {
            testScoreBtn.addEventListener('click', async () => {
                const addr = localStorage.getItem('userWalletAddress');
                if (!addr) {
                    alert("请先连接钱包");
                    return;
                }
                try {
                    // 先读取当前分数
                    const snap = await firebase.database().ref('users/' + addr + '/score').get();
                    let score = snap.exists() ? snap.val() : 0;
                    score = parseInt(score) + 100;
                    await firebase.database().ref('users/' + addr + '/score').set(score);
                    alert("测试积分已累加: " + score);
                    updateWalletScore();
                } catch (e) {
                    alert("写入失败: " + (e.message || e));
                }
            });
        }

        // 领取代币逻辑（提取为函数，主界面和右上角按钮共用）
        async function claimTokenHandler() {
            const addr = localStorage.getItem('userWalletAddress');
            console.log("领取时的钱包地址：", addr);
            if (!addr) {
                alert("请先连接钱包");
                return;
            }
            try {
                const claimToken = firebase.functions().httpsCallable("claimToken");
                claimToken({ wallet: addr })
                    .then(res => {
                        if (res.data.success) {
                            alert("领取成功！交易哈希：" + res.data.tx);
                            // 领取后刷新积分
                            updateWalletScore();
                        } else {
                            alert("领取失败");
                        }
                    })
                    .catch(err => {
                        alert("领取失败: " + (err.message || err));
                    });
            } catch (e) {
                alert("领取失败: " + (e.message || e));
            }
        }
        // 主界面领取按钮
        const claimTokenBtn = document.getElementById('claimTokenBtn');
        if (claimTokenBtn) {
            claimTokenBtn.addEventListener('click', claimTokenHandler);
        }
        // 右上角领取按钮
        const claimTokenBtnTop = document.getElementById('claimTokenBtnTop');
        if (claimTokenBtnTop) {
            claimTokenBtnTop.addEventListener('click', claimTokenHandler);
        }
    </script>
    <script>
    // ====== 多语言文本 ======
    // 切换语言按钮事件
    document.addEventListener('DOMContentLoaded', function() {
      const switchLangBtn = document.getElementById('switchLangBtn');
      if (switchLangBtn) {
        switchLangBtn.onclick = function() {
          currentLang = currentLang === 'zh' ? 'en' : 'zh';
          renderTexts();
        };
      }
      renderTexts();
    });
    </script>
</body>
</html>    
